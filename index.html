<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="format-detection" content="telephone=no, address=no, email=no">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Barlow:wght@400;500;600;700&family=Barlow+Condensed:wght@600;700;800&display=swap" rel="stylesheet">
<style>
:root{
  --bk:#080808;--dk:#0f0f0f;--dk2:#161616;--dk3:#1e1e1e;
  --br:#252525;--br2:#303030;
  --y:#f5c518;--y2:#ffd740;--yd:rgba(245,197,24,0.10);--yd2:rgba(245,197,24,0.04);
  --w:#fff;--tx:#e2e2e2;--tx2:#a8a8a8;--mu:#666;--mu2:#444;
  --gn:#22c55e;--gnd:rgba(34,197,94,0.1);--rd:#ef4444;
  --fn:'Barlow',sans-serif;--fc:'Barlow Condensed',sans-serif;
  --radius:6px;--radius-lg:10px;
  --shadow:0 4px 24px rgba(0,0,0,0.4);
  --transition:0.18s ease;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bk);color:var(--tx);font-family:var(--fn);min-height:100vh;font-size:13px;overscroll-behavior-y:none;-webkit-font-smoothing:antialiased;}
*{-webkit-tap-highlight-color:transparent;}
button,select,input,textarea{font-family:var(--fn);}
/* HEADER */
header{background:var(--dk);border-bottom:1px solid var(--br2);padding:0 20px;height:54px;display:flex;align-items:center;gap:14px;position:sticky;top:0;z-index:300;box-shadow:0 1px 0 var(--y),0 2px 20px rgba(0,0,0,0.5);}
.lb{background:var(--y);color:var(--bk);font-family:var(--fc);font-weight:800;font-size:10px;padding:4px 8px;border-radius:4px;letter-spacing:0.5px;}
.ln{font-family:var(--fc);font-size:15px;font-weight:700;color:var(--w);letter-spacing:0.3px;}
.ln span{color:var(--y);}
.hd{width:1px;height:20px;background:var(--br2);}
.ht{font-family:var(--fc);font-size:10px;font-weight:600;color:var(--mu);letter-spacing:1.5px;text-transform:uppercase;}
.hr{margin-left:auto;}.hbtn{background:none;border:1px solid var(--br2);color:var(--mu);border-radius:4px;padding:4px 8px;font-size:14px;cursor:pointer;line-height:1;transition:all var(--transition);}.hbtn:hover{border-color:var(--y);color:var(--y);}
.sp{background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.3);color:var(--gn);font-size:10px;padding:2px 8px;border-radius:20px;display:flex;align-items:center;gap:4px;opacity:0;transition:opacity 0.4s;}
.sp.show{opacity:1;}
/* LAYOUT */
.layout{display:grid;grid-template-columns:400px 1fr;min-height:calc(100vh - 54px);}
.fs{background:var(--dk);border-right:1px solid var(--br);overflow-y:auto;max-height:calc(100vh - 54px);scrollbar-width:thin;scrollbar-color:var(--br2) transparent;}
.fi{padding:20px 18px 32px;}
/* SCAN BANNER */
.sb{border-radius:var(--radius-lg);padding:14px 16px;margin-bottom:18px;background:linear-gradient(135deg,var(--dk2) 0%,rgba(245,197,24,0.04) 100%);border:1.5px dashed rgba(245,197,24,0.5);cursor:pointer;transition:all var(--transition);display:flex;align-items:center;gap:14px;}
.sb:hover{background:linear-gradient(135deg,var(--yd) 0%,rgba(245,197,24,0.08) 100%);border-color:var(--y);transform:translateY(-1px);}
.sb:active{transform:translateY(0);}
.sb-icon{font-size:28px;flex-shrink:0;line-height:1;}
.sb-text{flex:1;}
.sbt{font-family:var(--fc);font-size:12px;font-weight:800;letter-spacing:1px;text-transform:uppercase;color:var(--y);margin-bottom:3px;}
.sb p{font-size:11px;color:var(--tx2);line-height:1.5;}
.stag{display:inline-flex;background:var(--yd);border:1px solid rgba(245,197,24,0.3);color:var(--y);font-family:var(--fc);font-size:9px;font-weight:700;padding:2px 8px;border-radius:20px;margin-top:5px;letter-spacing:0.5px;}
/* OVERLAYS */
.ov{position:fixed;inset:0;background:rgba(0,0,0,0.88);z-index:500;display:flex;align-items:center;justify-content:center;padding:14px;overflow-y:auto;}
/* En m√≥vil el review modal se pega al fondo */
@media(max-width:700px){.ov.rev-ov{align-items:flex-end;padding:0;overflow-y:hidden;}}
.mo{background:var(--dk);border:1px solid var(--br2);border-top:3px solid var(--y);border-radius:9px;padding:20px;max-width:480px;width:100%;max-height:88vh;overflow-y:auto;}
.mot{font-family:var(--fc);font-size:14px;font-weight:800;color:var(--y);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:8px;}
.mo p{font-size:11px;color:var(--mu);line-height:1.7;margin-bottom:10px;}
.ib{background:rgba(245,197,24,0.06);border:1px solid rgba(245,197,24,0.2);border-radius:var(--radius);padding:10px 12px;margin-bottom:12px;font-size:11px;color:var(--tx2);line-height:1.7;}
.ib strong{color:var(--y);}
.dz{border:2px dashed var(--br2);border-radius:var(--radius-lg);padding:24px 16px;text-align:center;cursor:pointer;transition:all 0.2s;margin-bottom:10px;}
.dz:hover,.dz.over{border-color:var(--y);background:var(--yd);}
.dzi{font-size:36px;margin-bottom:8px;display:block;}
.dz p{font-size:12px;color:var(--mu);line-height:1.6;}
.dz strong{color:var(--y);font-family:var(--fc);}
.bq{display:flex;flex-direction:column;gap:6px;margin-bottom:12px;max-height:200px;overflow-y:auto;}
.bi{background:var(--dk2);border:1px solid var(--br);border-radius:6px;padding:8px 10px;display:flex;align-items:center;gap:9px;transition:border-color 0.2s;}
.bi.processing{border-color:var(--y);background:rgba(245,197,24,0.03);}
.bi.done{border-color:var(--gn);opacity:0.7;}
.bi.error{border-color:var(--rd);}
.bith{width:42px;height:42px;object-fit:cover;border-radius:3px;flex-shrink:0;border:1px solid var(--br);}
.bii{flex:1;min-width:0;}
.bin{font-family:var(--fc);font-size:10.5px;font-weight:600;color:var(--tx);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.bis{font-size:10px;margin-top:2px;}
.bis.pending{color:var(--mu);}
.bis.processing{color:var(--y);}
.bis.done{color:var(--gn);}
.bis.error{color:var(--rd);}
.birm{background:none;border:none;color:var(--mu2);font-size:12px;cursor:pointer;flex-shrink:0;}
.birm:hover{color:var(--rd);}
.mbtns{display:flex;gap:8px;}
.bstart{flex:1;background:var(--y);color:var(--bk);border:none;border-radius:var(--radius);padding:11px;font-family:var(--fc);font-size:13px;font-weight:800;text-transform:uppercase;cursor:pointer;letter-spacing:0.5px;transition:all var(--transition);}
.bstart:hover{background:var(--y2);transform:translateY(-1px);}
.bstart:disabled{opacity:0.4;cursor:default;}
.bcanc{background:none;border:1px solid var(--br2);color:var(--mu);border-radius:var(--radius);padding:11px 14px;font-size:11px;cursor:pointer;transition:all var(--transition);}
.bcanc:hover{border-color:var(--rd);color:var(--rd);}
/* REVIEW */
.rmo{background:var(--dk);border:1px solid var(--br2);border-top:3px solid var(--gn);border-radius:var(--radius-lg);padding:20px;max-width:660px;width:100%;overflow-y:auto;max-height:88vh;scrollbar-width:thin;scrollbar-color:var(--br2) transparent;}
.rmt{font-family:var(--fc);font-size:11px;font-weight:800;color:var(--gn);letter-spacing:2px;text-transform:uppercase;margin-bottom:3px;display:flex;align-items:center;gap:6px;}
.rmc{font-size:10px;color:var(--mu);margin-bottom:10px;padding-bottom:10px;border-bottom:1px solid var(--br);}
.rlay{display:grid;grid-template-columns:130px 1fr;gap:14px;margin-bottom:12px;}
.rimg{width:100%;border-radius:var(--radius);border:1px solid var(--br2);object-fit:contain;background:var(--dk2);max-height:180px;cursor:zoom-in;}
.rst{font-family:var(--fc);font-size:8.5px;font-weight:800;letter-spacing:2px;text-transform:uppercase;color:var(--y);margin-bottom:6px;padding-bottom:4px;border-bottom:1px solid var(--br2);display:flex;align-items:center;gap:6px;}.rst::before{content:"";display:block;width:3px;height:3px;border-radius:50%;background:var(--y);}
.rs{margin-bottom:12px;}
.rg{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:6px;}
.rg.c1{grid-template-columns:1fr;}
.rg.c3{grid-template-columns:1fr 1fr 1fr;}
.rf label{display:block;font-size:8px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--mu);margin-bottom:3px;}
.rf input,.rf select{width:100%;background:var(--dk2);border:1px solid var(--br2);border-radius:4px;padding:6px 8px;color:var(--tx);font-family:var(--fn);font-size:11px;outline:none;transition:border-color var(--transition),box-shadow var(--transition);}
.rf input:focus,.rf select:focus{border-color:var(--y);box-shadow:0 0 0 2px rgba(245,197,24,0.1);}
.rf input.sc,.rf select.sc{border-color:rgba(245,197,24,0.6);background:rgba(245,197,24,0.06);}
.tabs{display:flex;gap:4px;margin-bottom:10px;}
.tab{flex:1;padding:8px 5px;background:var(--dk2);border:1px solid var(--br);border-radius:var(--radius);font-family:var(--fc);font-size:11px;font-weight:700;color:var(--mu);cursor:pointer;text-align:center;transition:all var(--transition);-webkit-appearance:none;appearance:none;outline:none;}
.tab:hover{color:var(--tx2);border-color:var(--br2);}
.tab.active{background:var(--y);border-color:var(--y);color:var(--bk);font-weight:800;}
.mp{display:none;}
.mp.active{display:block;}
.rbtns{display:flex;gap:8px;margin-top:10px;padding-bottom:env(safe-area-inset-bottom,0px);}
@media(max-width:700px){.rbtns{position:sticky;bottom:0;background:var(--dk);padding:10px 0 calc(10px + env(safe-area-inset-bottom,16px));margin-top:8px;}}
.bsave{flex:1;background:var(--gn);color:var(--bk);border:none;border-radius:var(--radius);padding:12px;font-family:var(--fc);font-size:13px;font-weight:800;text-transform:uppercase;cursor:pointer;transition:all var(--transition);letter-spacing:0.5px;}
.bsave:hover{background:#16a34a;transform:translateY(-1px);box-shadow:0 4px 16px rgba(34,197,94,0.25);}
.bsave:active{transform:translateY(0);}
.bskip{background:var(--dk2);border:1px solid var(--br2);color:var(--mu);border-radius:var(--radius);padding:12px 16px;font-size:11px;cursor:pointer;font-family:var(--fc);font-weight:700;transition:all var(--transition);white-space:nowrap;}
.bskip:hover{border-color:var(--br2);color:var(--tx2);background:var(--dk3);}
/* FORM */
.sec{display:flex;align-items:center;gap:10px;margin:22px 0 12px;}
.sec:first-child{margin-top:0;}
.sn{background:var(--y);color:var(--bk);font-family:var(--fc);font-weight:800;font-size:9px;width:18px;height:18px;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.sl{font-family:var(--fc);font-size:10px;font-weight:800;letter-spacing:2.5px;text-transform:uppercase;color:var(--y);}
.sl2{flex:1;height:1px;background:var(--br);}
.fg{display:grid;gap:8px;margin-bottom:8px;}
.fg.c2{grid-template-columns:1fr 1fr;}
.fg.c3{grid-template-columns:1fr 1fr 1fr;}
.fg.c1{grid-template-columns:1fr;}
label{display:block;font-size:9px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--mu);margin-bottom:4px;}
input[type=text],input[type=number],select,textarea{width:100%;background:var(--dk2);border:1px solid var(--br2);border-radius:var(--radius);padding:8px 10px;color:var(--tx);font-family:var(--fn);font-size:12px;outline:none;transition:border-color var(--transition),background var(--transition),box-shadow var(--transition);-webkit-appearance:none;appearance:none;}
input[type=text]:hover,input[type=number]:hover,select:hover,textarea:hover{border-color:var(--br2);background:var(--dk3);}
input:focus,select:focus,textarea:focus{border-color:var(--y);background:var(--dk3);box-shadow:0 0 0 3px rgba(245,197,24,0.08);}
select option{background:var(--dk2);}
textarea{resize:vertical;min-height:50px;}
.tp{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:6px;}
.tc{background:var(--dk2);border:1px solid var(--br);border-radius:var(--radius);padding:11px;}
.tc.a{border-top:2px solid var(--y);}
.tc.b{border-top:2px solid var(--mu2);}
.th{font-family:var(--fc);font-size:9px;font-weight:800;letter-spacing:2px;text-transform:uppercase;margin-bottom:9px;display:flex;align-items:center;gap:6px;}
.th.a{color:var(--y);}
.th.b{color:var(--mu);}
.th::before{content:'';width:6px;height:6px;border-radius:50%;background:currentColor;flex-shrink:0;}
.fii{margin-bottom:5px;}
.fii:last-child{margin-bottom:0;}
.bgen{width:100%;margin-top:16px;padding:13px;background:var(--y);color:var(--bk);border:none;border-radius:var(--radius);font-family:var(--fc);font-size:13px;font-weight:800;letter-spacing:1.5px;text-transform:uppercase;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:all var(--transition);}
.bgen:hover{background:var(--y2);transform:translateY(-1px);box-shadow:0 4px 16px rgba(245,197,24,0.25);}
.bgen:active{transform:translateY(0);box-shadow:none;}
/* TABLE */
.ts{display:flex;flex-direction:column;overflow:hidden;}
.th2{display:flex;align-items:center;justify-content:space-between;padding:12px 18px;border-bottom:1px solid var(--br);flex-shrink:0;background:var(--dk);}
.ttl{font-family:var(--fc);font-size:11px;font-weight:800;letter-spacing:1.5px;text-transform:uppercase;color:var(--tx2);display:flex;align-items:center;gap:8px;}
.cb{background:var(--yd);border:1px solid rgba(245,197,24,0.3);color:var(--y);font-size:10px;font-weight:600;padding:1px 8px;border-radius:20px;}
.tacts{display:flex;gap:6px;}
.bxl{background:var(--y);color:var(--bk);border:none;border-radius:var(--radius);padding:7px 14px;font-family:var(--fc);font-size:11px;font-weight:800;text-transform:uppercase;cursor:pointer;letter-spacing:0.5px;transition:all var(--transition);}
.bxl:hover{background:var(--y2);transform:translateY(-1px);}
.bxl:disabled{opacity:0.35;cursor:default;}
.bclr{background:none;border:1px solid var(--br2);color:var(--mu);border-radius:var(--radius);padding:7px 10px;font-size:10px;cursor:pointer;transition:all var(--transition);}
.bclr:hover{border-color:var(--rd);color:var(--rd);}
.empty{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;color:var(--mu2);padding:40px 20px;}
.ei{width:64px;height:64px;border:2px dashed var(--br2);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:28px;opacity:0.5;}
.empty p{font-size:12px;text-align:center;line-height:1.9;}
.empty strong{color:var(--y);}
.tw{overflow:auto;flex:1;}
table{width:100%;border-collapse:collapse;font-size:11px;}
thead th{background:var(--dk2);color:var(--tx2);font-family:var(--fc);font-size:8px;font-weight:800;letter-spacing:1.5px;text-transform:uppercase;padding:9px 10px;text-align:left;border-bottom:1px solid var(--br);white-space:nowrap;position:sticky;top:0;z-index:10;border-right:1px solid var(--br);}
thead th:last-child{border-right:none;}
tbody tr{border-bottom:1px solid var(--br);transition:background 0.1s;}
tbody tr:hover{background:var(--yd2);}
tbody tr.nr{animation:ri 0.5s ease;}
@keyframes ri{from{background:rgba(245,197,24,0.1);}to{background:transparent;}}
tbody td{padding:8px 10px;vertical-align:top;color:var(--tx);white-space:nowrap;border-right:1px solid var(--br);font-size:11px;}
tbody td:last-child{border-right:none;}
td.num{color:var(--mu2);font-size:9px;text-align:center;}
td.dc{white-space:normal;max-width:200px;line-height:1.6;color:var(--mu);font-size:9.5px;}
td.wc{white-space:normal;max-width:120px;font-size:9.5px;line-height:1.5;}
.chip{display:inline-flex;background:var(--yd);border:1px solid rgba(245,197,24,0.2);color:var(--y);font-family:var(--fc);font-weight:700;font-size:9px;padding:2px 7px;border-radius:20px;letter-spacing:0.3px;}
.ra{display:flex;gap:3px;}
.bcp,.bdl{background:none;border:1px solid var(--br2);color:var(--mu);border-radius:4px;padding:3px 8px;font-size:10px;cursor:pointer;transition:all 0.15s;}
.bcp:hover{border-color:var(--y);color:var(--y);}
.bdl:hover{border-color:var(--rd);color:var(--rd);}
.bcp.ok{border-color:var(--gn);color:var(--gn);}
.toast{position:fixed;top:66px;right:16px;background:var(--dk);border-radius:var(--radius);padding:10px 14px;font-size:12px;font-weight:600;transform:translateY(-10px);opacity:0;transition:all 0.25s cubic-bezier(0.34,1.56,0.64,1);z-index:9999;box-shadow:var(--shadow);max-width:280px;}
.toast.ok{border:1px solid var(--gn);color:var(--gn);}
.toast.warn{border:1px solid var(--y);color:var(--y);}
.toast.err{border:1px solid var(--rd);color:var(--rd);}
.toast.show{transform:translateY(0);opacity:1;}
#fbi{display:none;}

/* API KEY MODAL */
.akmo{background:var(--dk);border:1px solid var(--br2);border-top:3px solid var(--y);border-radius:var(--radius-lg);padding:28px;max-width:400px;width:100%;}
.akmo h2{font-family:var(--fc);font-size:16px;font-weight:800;color:var(--y);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:8px;}
.akmo p{font-size:11.5px;color:var(--mu);line-height:1.7;margin-bottom:12px;}
.akmo .hint{background:var(--yd);border:1px solid rgba(245,197,24,0.25);border-radius:5px;padding:8px 11px;font-size:10.5px;color:var(--y);line-height:1.7;margin-bottom:12px;}
.akmo input{width:100%;background:var(--dk2);border:1px solid var(--br2);border-radius:var(--radius);padding:11px 13px;color:var(--tx);font-family:monospace;font-size:12px;outline:none;margin-bottom:12px;transition:border-color var(--transition);}
.akmo input:focus{border-color:var(--y);}
.akmo .err{font-size:10.5px;color:var(--rd);margin-bottom:8px;display:none;}
.bconf{width:100%;background:var(--y);color:var(--bk);border:none;border-radius:5px;padding:10px;font-family:var(--fc);font-size:13px;font-weight:800;text-transform:uppercase;cursor:pointer;}
.bconf:hover{background:var(--y2);}
.bconf:disabled{opacity:0.4;cursor:default;}

/* ‚îÄ‚îÄ MOBILE ‚îÄ‚îÄ */
@media (max-width: 700px) {
  /* Ocultar layout de escritorio, mostrar hero */
  .layout{display:none;}
  .hero-mobile{display:flex;}
  /* Modales full screen */
  .mo{max-width:100%;width:100%;border-radius:16px 16px 0 0;position:fixed;bottom:0;left:0;max-height:92vh;margin:0;}
  .rmo{max-width:100%;width:100%;border-radius:16px 16px 0 0;max-height:92vh;}
  /* Review modal ‚Äî formulario apilado */
  .rlay{grid-template-columns:1fr;}
  .rimg{max-height:120px;object-fit:cover;}
  .rg,.rg.c3{grid-template-columns:1fr;}
  /* Barra fija inferior */
  #mobileBar{display:flex;}
  .toast{right:14px;left:14px;max-width:unset;text-align:center;}
}
@media (min-width: 701px){
  #mobileNote{display:none;}
  #mobileBar{display:none;}
}
/* Barra fija inferior m√≥vil */
#mobileBar{
  display:none;
  position:fixed;bottom:0;left:0;right:0;z-index:400;
  background:rgba(15,15,15,0.95);
  border-top:1px solid var(--br2);
  padding:12px 16px calc(12px + env(safe-area-inset-bottom,0px));
  align-items:center;justify-content:space-between;gap:12px;
  box-shadow:0 -1px 0 var(--br),0 -8px 32px rgba(0,0,0,0.5);
  backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);
}
#mobileBar .mb-cnt{font-family:var(--fc);font-size:11px;color:var(--mu);white-space:nowrap;}
#mobileBar .mb-cnt strong{color:var(--y);font-size:18px;display:block;line-height:1.1;}
#mobileBar .mb-xl{
  flex:1;background:var(--y);color:var(--bk);border:none;border-radius:var(--radius);
  padding:13px;font-family:var(--fc);font-size:14px;font-weight:800;
  text-transform:uppercase;letter-spacing:1px;cursor:pointer;
  transition:all var(--transition);
}
#mobileBar .mb-xl:disabled{opacity:0.3;cursor:default;}
#mobileBar .mb-xl:active{transform:scale(0.97);}

/* Scrollbar */
::-webkit-scrollbar{width:6px;height:6px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--br2);border-radius:3px;}
::-webkit-scrollbar-thumb:hover{background:var(--mu2);}

/* ‚îÄ‚îÄ HERO MOBILE ‚îÄ‚îÄ */
.hero-mobile{display:none;flex-direction:column;align-items:center;justify-content:center;min-height:calc(100vh - 54px);padding:40px 28px 40px;text-align:center;background:var(--bk);}
.hero-logo{font-family:var(--fc);font-size:11px;font-weight:800;letter-spacing:3px;text-transform:uppercase;color:var(--mu);margin-bottom:32px;}
.hero-logo span{color:var(--y);}
.hero-cam-btn{width:150px;height:150px;border-radius:50%;background:var(--y);border:none;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;box-shadow:0 0 0 16px rgba(245,197,24,0.07),0 0 0 32px rgba(245,197,24,0.03);transition:all 0.2s;margin-bottom:24px;position:relative;}
.hero-cam-btn::after{content:'';position:absolute;inset:-16px;border-radius:50%;border:1px solid rgba(245,197,24,0.15);animation:pulse 2.5s ease-in-out infinite;}
@keyframes pulse{0%,100%{transform:scale(1);opacity:1;}50%{transform:scale(1.06);opacity:0.4;}}
.hero-cam-btn:active{transform:scale(0.94);}
.hero-cam-btn .cam-icon{font-size:56px;line-height:1;}
.hero-cam-btn .cam-label{font-family:var(--fc);font-size:13px;font-weight:800;letter-spacing:1px;text-transform:uppercase;color:var(--bk);}
.hero-sub{font-size:13px;color:var(--mu);line-height:1.7;margin-bottom:24px;}
.hero-sub strong{color:var(--tx);}
.hero-excel-btn{width:100%;background:var(--y);color:var(--bk);border:none;border-radius:var(--radius);padding:14px;font-family:var(--fc);font-size:14px;font-weight:800;letter-spacing:1px;text-transform:uppercase;cursor:pointer;transition:all var(--transition);}
.hero-excel-btn:disabled{opacity:0.3;cursor:default;}
.hero-excel-btn:not(:disabled):active{transform:scale(0.97);}
.hero-manual-btn{background:none;border:1px solid var(--br2);color:var(--mu);border-radius:var(--radius);padding:10px 20px;font-size:12px;font-family:var(--fc);font-weight:700;letter-spacing:0.5px;cursor:pointer;transition:all var(--transition);}
.hero-manual-btn:active{background:var(--dk2);}
.hero-stats{display:flex;gap:20px;margin-top:28px;}
.hero-stat{text-align:center;}
.hero-stat strong{display:block;font-family:var(--fc);font-size:22px;font-weight:800;color:var(--y);}
.hero-stat span{font-size:10px;color:var(--mu);letter-spacing:0.5px;text-transform:uppercase;}

/* ‚îÄ‚îÄ COLLAPSIBLE FORM ‚îÄ‚îÄ */
.form-toggle{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--dk2);border:1px solid var(--br);border-radius:var(--radius);cursor:pointer;margin-bottom:0;transition:all var(--transition);}
.form-toggle:hover{border-color:var(--br2);}
.form-toggle-label{font-family:var(--fc);font-size:11px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--mu);}
.form-toggle-icon{font-size:12px;color:var(--mu);transition:transform 0.2s;}
.form-toggle.open .form-toggle-icon{transform:rotate(180deg);}
.form-collapse{overflow:hidden;max-height:0;transition:max-height 0.35s cubic-bezier(0.4,0,0.2,1);}
.form-collapse.open{max-height:2000px;}
.form-collapse-inner{padding-top:16px;}

/* ‚îÄ‚îÄ DESKTOP SCAN HERO ‚îÄ‚îÄ */
.scan-hero{background:linear-gradient(160deg,var(--dk2) 0%,rgba(245,197,24,0.05) 100%);border:1px solid rgba(245,197,24,0.15);border-radius:var(--radius-lg);padding:24px 20px;margin-bottom:14px;text-align:center;}
.scan-hero-icon{font-size:40px;margin-bottom:10px;display:block;}
.scan-hero-title{font-family:var(--fc);font-size:16px;font-weight:800;color:var(--w);letter-spacing:0.5px;margin-bottom:6px;}
.scan-hero-sub{font-size:11.5px;color:var(--tx2);line-height:1.6;margin-bottom:16px;}
.scan-hero-btn{width:100%;background:var(--y);color:var(--bk);border:none;border-radius:var(--radius);padding:14px;font-family:var(--fc);font-size:14px;font-weight:800;letter-spacing:1.5px;text-transform:uppercase;cursor:pointer;transition:all var(--transition);display:flex;align-items:center;justify-content:center;gap:10px;}
.scan-hero-btn:hover{background:var(--y2);transform:translateY(-1px);box-shadow:0 6px 20px rgba(245,197,24,0.3);}
.scan-hero-btn:active{transform:translateY(0);}
.scan-hero-pills{display:flex;justify-content:center;gap:8px;margin-top:12px;}
.scan-pill{background:var(--dk);border:1px solid var(--br2);border-radius:20px;padding:3px 10px;font-size:10px;color:var(--mu);font-family:var(--fc);font-weight:600;}

/* ‚îÄ‚îÄ SESSION COUNTER ‚îÄ‚îÄ */
.session-bar{display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--dk2);border:1px solid var(--br);border-radius:var(--radius);margin-bottom:12px;font-size:11px;color:var(--mu);}
.session-bar strong{color:var(--y);font-family:var(--fc);font-size:13px;}
.session-bar .sep{flex:1;}
.session-bar .s-excel{background:none;border:1px solid var(--br2);color:var(--mu);border-radius:4px;padding:3px 10px;font-size:10px;font-family:var(--fc);font-weight:700;cursor:pointer;transition:all var(--transition);}
.session-bar .s-excel:hover{border-color:var(--y);color:var(--y);}
.session-bar .s-excel:disabled{opacity:0.3;cursor:default;}


/* Drop zone camera/file split */
.dz-cam-row{display:none;gap:8px;margin-bottom:10px;}
.dz-cam-btn,.dz-file-btn{flex:1;padding:11px;border-radius:var(--radius);font-family:var(--fc);font-size:12px;font-weight:800;cursor:pointer;transition:all var(--transition);}
.dz-cam-btn{background:var(--y);color:var(--bk);border:none;}
.dz-file-btn{background:none;border:1px solid var(--br2);color:var(--tx2);}
.dz-cam-btn:active,.dz-file-btn:active{transform:scale(0.97);}
@media(max-width:700px){.dz-cam-row{display:flex;}.dz{display:none;}}


/* Progress bar */
.prog-wrap{margin-bottom:12px;display:none;}
.prog-wrap.show{display:block;}
.prog-label{font-size:10px;color:var(--mu);margin-bottom:5px;display:flex;justify-content:space-between;}
.prog-label strong{color:var(--y);}
.prog-bar{height:3px;background:var(--br);border-radius:2px;overflow:hidden;}
.prog-fill{height:100%;background:var(--y);border-radius:2px;transition:width 0.4s ease;width:0%;}


/* Confirm dialog */
.conf-ov{position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:600;display:flex;align-items:center;justify-content:center;padding:20px;}
.conf-box{background:var(--dk);border:1px solid var(--br2);border-top:3px solid var(--rd);border-radius:var(--radius-lg);padding:24px;max-width:320px;width:100%;}
.conf-title{font-family:var(--fc);font-size:13px;font-weight:800;color:var(--tx);margin-bottom:6px;}
.conf-msg{font-size:11.5px;color:var(--mu);margin-bottom:18px;line-height:1.6;}
.conf-btns{display:flex;gap:8px;}
.conf-cancel{flex:1;background:none;border:1px solid var(--br2);color:var(--mu);border-radius:var(--radius);padding:9px;font-family:var(--fc);font-size:12px;font-weight:700;cursor:pointer;transition:all var(--transition);}
.conf-cancel:hover{border-color:var(--br2);color:var(--tx);}
.conf-ok{flex:1;background:var(--rd);color:white;border:none;border-radius:var(--radius);padding:9px;font-family:var(--fc);font-size:12px;font-weight:800;cursor:pointer;transition:all var(--transition);}
.conf-ok:hover{background:#dc2626;}

</style>
</head>
<body>

<!-- SCAN MODAL -->
<div class="ov" id="scanOv" style="display:none">
  <div class="mo">
    <div class="mot">üì∑ Cargar formato f√≠sico</div>
    <div class="ib"><strong>Formato 4 cuadrantes:</strong> Datos generales + Manguera 1 + Manguera 2 + Manguera 3<br><strong>1 foto ‚Üí hasta 3 registros autom√°ticos</strong></div>
    <div class="dz" id="dz" onclick="document.getElementById('fbi').click()">
      <div class="dzi">üìé</div>
      <p><strong>Haz clic para seleccionar</strong><br>o arrastra las im√°genes aqu√≠</p>
    </div>
    <input type="file" id="fbi" accept="image/*" capture="environment" multiple onchange="onFiles(event)">
    <div class="dz-cam-row">
      <button class="dz-cam-btn" onclick="document.getElementById('fbi').click()">üì∑ C√°mara</button>
      <button class="dz-file-btn" onclick="triggerFileOnly()">üóÇ Archivo</button>
    </div>
    <div class="bq" id="bq" style="display:none"></div>
    <div class="prog-wrap" id="progWrap">
      <div class="prog-label"><span id="progText">Analizando...</span><strong id="progPct">0%</strong></div>
      <div class="prog-bar"><div class="prog-fill" id="progFill"></div></div>
    </div>
    <div class="mbtns">
      <button class="bstart" id="bstart" onclick="runBatch()" disabled>‚ö° Analizar formatos</button>
      <button class="bcanc" onclick="closeScan()">Cancelar</button>
    </div>
  </div>
</div>

<!-- REVIEW MODAL -->
<div class="ov rev-ov" id="revOv" style="display:none">
  <div class="rmo">
    <div class="rmt"><span style="color:var(--gn)">‚úì</span> Revisar datos extra√≠dos</div>
    <div class="rmc" id="rmc"></div>
    <div class="rlay">
      <img class="rimg" id="rimg" src="" alt="">
      <div>
        <div class="rs">
          <div class="rst">Datos generales</div>
          <div class="rg c1" style="margin-bottom:3px"><div class="rf"><label>Empresa / Cliente</label><input type="text" id="r_empresa"></div></div>
          <div class="rg" style="margin-bottom:3px">
            <div class="rf"><label>Planta</label><input type="text" id="r_planta"></div>
            <div class="rf"><label>Subplanta</label><input type="text" id="r_subplanta"></div>
          </div>
          <div class="rg" style="margin-bottom:3px">
            <div class="rf"><label>M√°quina</label><input type="text" id="r_maquina"></div>
            <div class="rf"><label>Equipo</label><input type="text" id="r_equipo"></div>
          </div>
          <div class="rg c1" style="margin-bottom:3px"><div class="rf"><label>Sub-Equipo / Ubicaci√≥n</label><input type="text" id="r_subequipo"></div></div>
          <div class="rg">
            <div class="rf"><label>T√©cnico</label><input type="text" id="r_tecnico"></div>
            <div class="rf"><label>Fecha</label><input type="text" id="r_fecha_lev"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="rs">
      <div class="rst">Mangueras</div>
      <div class="tabs">
        <div class="tab active" onclick="swTab(1)"><span>Manguera&nbsp;1</span></div>
        <div class="tab" onclick="swTab(2)"><span>Manguera&nbsp;2</span></div>
        <div class="tab" onclick="swTab(3)"><span>Manguera&nbsp;3</span></div>
      </div>
      <div id="mp1" class="mp active"></div>
      <div id="mp2" class="mp"></div>
      <div id="mp3" class="mp"></div>
    </div>
    <div class="rbtns">
      <button class="bsave" onclick="saveRev()">‚úì Guardar registros</button>
      <button class="bskip" onclick="skipRev()">Omitir esta hoja</button>
    </div>
  </div>
</div>

<!-- HEADER -->

<!-- API KEY MODAL -->
<div class="ov" id="akOv">
  <div class="akmo">
    <h2>üîë Configurar API Key</h2>
    <p>Para usar el esc√°ner de fotos necesitas una API Key de Anthropic. Se guarda solo en tu navegador, nunca se comparte.</p>
    <div class="hint">
      1. Ve a <strong>console.anthropic.com</strong><br>
      2. API Keys ‚Üí Create Key<br>
      3. Pega la key aqu√≠ abajo
    </div>
    <input type="password" id="akInput" placeholder="sk-ant-api03-..." oninput="document.getElementById('bconf').disabled=!this.value.startsWith('sk-ant')">
    <div class="err" id="akErr">La key debe comenzar con sk-ant-api03-</div>
    <button class="bconf" id="bconf" onclick="saveKey()" disabled>Guardar y continuar</button>
  </div>
</div>

<header>
  <div class="lb">SR</div>
  <div class="ln">Suminregio <span>Industrial</span></div>
  <div class="hd"></div>
  <div class="ht">Levantamiento ¬∑ Mangueras</div>
  <div class="hr" style="display:flex;align-items:center;gap:10px;">
    <div class="sp" id="sp">‚úì Guardado</div>
    <button class="hbtn" onclick="document.getElementById('akOv').style.display='flex'" title="Configurar API Key">‚öô</button>
  </div>
</header>

<!-- HERO M√ìVIL -->
<div class="hero-mobile" id="heroMobile">

  <button class="hero-cam-btn" onclick="openScan()">
    <span class="cam-icon">üì∑</span>
    <span class="cam-label">Escanear</span>
  </button>
  <p class="hero-sub">Toma una foto del formato f√≠sico.<br><strong>Claude extrae los datos autom√°ticamente.</strong></p>
  <div class="hero-stats">
    <div class="hero-stat"><strong id="heroCount">0</strong><span>Registros</span></div>
    <div style="width:1px;height:32px;background:var(--br);align-self:center;"></div>
    <div class="hero-stat"><strong id="heroSheets">0</strong><span>Formatos</span></div>
  </div>
  <div style="margin-top:20px;display:flex;flex-direction:column;gap:10px;width:100%;max-width:280px;">
    <button class="hero-excel-btn" id="mbExcel" onclick="exportExcel()" disabled>‚¨á Descargar Excel</button>
    <button class="hero-manual-btn" onclick="openManualMobile()">‚úé Captura manual</button>
  </div>
</div>

<!-- FORMULARIO MANUAL M√ìVIL (modal) -->
<div class="ov" id="manualMobOv" style="display:none;align-items:flex-end;padding:0;">
  <div style="background:var(--dk);border:1px solid var(--br2);border-top:3px solid var(--y);border-radius:16px 16px 0 0;width:100%;max-height:92vh;overflow-y:auto;padding:20px;">
    <div style="font-family:var(--fc);font-size:13px;font-weight:800;color:var(--y);letter-spacing:1px;text-transform:uppercase;margin-bottom:14px;display:flex;justify-content:space-between;align-items:center;">
      ‚úé Captura manual
      <button onclick="document.getElementById('manualMobOv').style.display='none'" style="background:none;border:none;color:var(--mu);font-size:18px;cursor:pointer;line-height:1;">‚úï</button>
    </div>
    <div class="sec" style="margin-top:0;"><div class="sn">1</div><div class="sl">Ubicaci√≥n</div><div class="sl2"></div></div>
    <div class="fg c1"><div><label>Planta</label><input type="text" id="m_planta" placeholder="Ej: CHURUBUSCO"></div></div>
    <div class="fg c1"><div><label>Subplanta</label><input type="text" id="m_subplanta" placeholder="Ej: DECAPADO 1"></div></div>
    <div class="fg c1"><div><label>M√°quina</label><input type="text" id="m_maquina" placeholder="Ej: PINCH ROLL"></div></div>
    <div class="fg c1"><div><label>Equipo</label><input type="text" id="m_equipo" placeholder="Ej: RODILLO CUNA 1"></div></div>
    <div class="fg c1"><div><label>Donde se conecta</label><input type="text" id="m_ubicacion" placeholder="Ej: SALIDA B"></div></div>
    <div class="sec"><div class="sn">2</div><div class="sl">Manguera</div><div class="sl2"></div></div>
    <div class="fg c1"><div><label>Di√°metro</label><select id="m_diametro"><option value="">--</option><option>1/4"</option><option>3/8"</option><option>1/2"</option><option>5/8"</option><option>3/4"</option><option>1"</option><option>1 1/4"</option><option>1 1/2"</option><option>2"</option></select></div></div>
    <div class="fg c1"><div><label>Tipo SAE</label><select id="m_sae"><option value="">--</option><option>100R2AT</option><option>100R12</option></select></div></div>
    <div class="fg c1"><div><label>Presi√≥n (PSI)</label><select id="m_presion"><option value="">--</option><option value="3000">3K ‚Äî 3000 PSI</option><option value="4000">4K ‚Äî 4000 PSI</option><option value="5000">5K ‚Äî 5000 PSI</option><option value="6000">6K ‚Äî 6000 PSI</option></select></div></div>
    <div class="fg c1"><div><label>Longitud (MM)</label><input type="number" id="m_longitud" placeholder="570"></div></div>
    <div class="fg c1"><div><label>Recubrimiento</label><input type="text" id="m_recubrimiento" placeholder="ANTIFLAMA"></div></div>
    <div class="sec"><div class="sn">3</div><div class="sl">Terminales</div><div class="sl2"></div></div>
    <div class="fg c1"><div><label>Conector A</label><input type="text" id="m_conA" placeholder='JIC 3/4" HEMBRA RECTO'></div></div>
    <div class="fg c1"><div><label>Adaptador A</label><input type="text" id="m_adaptA" placeholder="BRIDA 3/4 RECTA"></div></div>
    <div class="fg c1"><div><label>Conector B</label><input type="text" id="m_conB" placeholder='JIC 3/4" HEMBRA RECTO'></div></div>
    <div class="fg c1"><div><label>Adaptador B</label><input type="text" id="m_adaptB" placeholder="BRIDA 90¬∞ 3/4"></div></div>
    <div class="sec"><div class="sn">4</div><div class="sl">Observaciones</div><div class="sl2"></div></div>
    <div class="fg c1"><div><label>Comentarios</label><textarea id="m_comentarios" placeholder="Notas..."></textarea></div></div>
    <button class="bgen" onclick="addEntryMobile()" style="margin-bottom:20px;">‚ö° Guardar registro</button>
  </div>
</div>

<div class="layout">
  <!-- FORM -->
  <div class="fs">
    <div class="fi">

      <!-- SCAN HERO ‚Äî desktop -->
      <div class="scan-hero">
        <span class="scan-hero-icon">üì∑</span>
        <div class="scan-hero-title">Escanear formato f√≠sico</div>
        <div class="scan-hero-sub">Toma una foto del formato de 4 cuadrantes.<br>Claude extrae los datos de las 3 mangueras autom√°ticamente.</div>
        <button class="scan-hero-btn" onclick="openScan()">
          <span>‚ö°</span> Cargar foto del formato
        </button>
        <div class="scan-hero-pills">
          <span class="scan-pill">‚úì Datos generales</span>
          <span class="scan-pill">‚úì 3 mangueras</span>
          <span class="scan-pill">‚úì Export Excel</span>
        </div>
      </div>

      <!-- SESSION COUNTER -->
      <div class="session-bar" id="sessionBar">
        <span>Registros en sesi√≥n:</span>
        <strong id="rc2">0</strong>
        <span class="sep"></span>
        <button class="s-excel" id="bex2" onclick="exportExcel()" disabled>‚Üì Excel</button>
      </div>

      <!-- FORMULARIO MANUAL COLAPSABLE -->
      <div class="form-toggle" id="formToggle" onclick="toggleForm()">
        <span class="form-toggle-label">‚úé Captura manual</span>
        <span class="form-toggle-icon">‚ñº</span>
      </div>
      <div class="form-collapse" id="formCollapse">
        <div class="form-collapse-inner">

          <div class="sec"><div class="sn">1</div><div class="sl">Ubicaci√≥n</div><div class="sl2"></div></div>
          <div class="fg c2">
            <div><label>Planta</label><input type="text" id="planta" placeholder="Ej: CHURUBUSCO"></div>
            <div><label>Subplanta</label><input type="text" id="subplanta" placeholder="Ej: DECAPADO 1"></div>
          </div>
          <div class="fg c2">
            <div><label>M√°quina</label><input type="text" id="maquina" placeholder="Ej: PINCH ROLL"></div>
            <div><label>Equipo</label><input type="text" id="equipo" placeholder="Ej: RODILLO CUNA 1"></div>
          </div>
          <div class="fg c1"><div><label>Donde se conecta</label><input type="text" id="ubicacion" placeholder="Ej: SALIDA B / MANGUERA A"></div></div>

          <div class="sec"><div class="sn">2</div><div class="sl">Manguera</div><div class="sl2"></div></div>
          <div class="fg c3">
            <div><label>Di√°metro</label><select id="diametro"><option value="">--</option><option>1/4"</option><option>3/8"</option><option>1/2"</option><option>5/8"</option><option>3/4"</option><option>1"</option><option>1 1/4"</option><option>1 1/2"</option><option>2"</option></select></div>
            <div><label>Tipo SAE</label><select id="sae"><option value="">--</option><option>100R2AT</option><option>100R12</option></select></div>
            <div><label>Presi√≥n (PSI)</label>
              <select id="presion">
                <option value="">--</option>
                <option value="3000">3K ‚Äî 3000 PSI</option>
                <option value="4000">4K ‚Äî 4000 PSI</option>
                <option value="5000">5K ‚Äî 5000 PSI</option>
                <option value="6000">6K ‚Äî 6000 PSI</option>
              </select></div>
          </div>
          <div class="fg c2">
            <div><label>Longitud (MM)</label><input type="number" id="longitud" placeholder="570"></div>
            <div><label>Recubrimiento</label><input type="text" id="recubrimiento" placeholder="ANTIFLAMA / ESPIRAL MET√ÅLICO"></div>
          </div>

          <div class="sec"><div class="sn">3</div><div class="sl">Terminales</div><div class="sl2"></div></div>
          <div class="tp">
            <div class="tc a"><div class="th a">Terminal A</div>
              <div class="fii"><label>Conector</label><input type="text" id="conA" placeholder='JIC 3/4" HEMBRA RECTO'></div>
              <div class="fii"><label>Adaptador</label><input type="text" id="adaptA" placeholder="BRIDA 3/4 RECTA"></div>
            </div>
            <div class="tc b"><div class="th b">Terminal B</div>
              <div class="fii"><label>Conector</label><input type="text" id="conB" placeholder='JIC 3/4" HEMBRA RECTO'></div>
              <div class="fii"><label>Adaptador</label><input type="text" id="adaptB" placeholder="BRIDA 90¬∞ 3/4"></div>
            </div>
          </div>

          <div class="sec"><div class="sn">4</div><div class="sl">Observaciones</div><div class="sl2"></div></div>
          <div class="fg c1"><div><label>Comentarios</label><textarea id="comentarios" placeholder="Mejoras, notas de ruteo, cambios, etc."></textarea></div></div>
          <button class="bgen" onclick="addEntry()">‚ö° Guardar y generar descripci√≥n</button>

        </div>
      </div>
    </div>
  </div>

  <!-- TABLE -->
  <div class="ts">
    <div class="th2">
      <div class="ttl">Registros <span class="cb" id="rc">0</span></div>
      <div class="tacts">
        <button class="bxl" id="bex" onclick="exportExcel()" disabled>‚Üì Excel</button>
        <button class="bclr" onclick="clearAll()">Limpiar</button>
      </div>
    </div>

    <div class="empty" id="em">
      <div class="ei">üóÇÔ∏è</div>
      <p style="color:var(--mu)">Sin registros a√∫n</p>
      <p style="font-size:11px;color:var(--mu2);max-width:220px;">Carga una foto del formato f√≠sico o llena el formulario manual para comenzar.</p>
      <div style="display:flex;align-items:center;gap:6px;margin-top:4px;background:var(--dk2);border:1px solid var(--br);border-radius:20px;padding:5px 12px;">
        <span style="font-size:10px;color:var(--y);font-family:var(--fc);font-weight:700;letter-spacing:0.5px;">‚ú¶ 1 foto = hasta 3 registros autom√°ticos</span>
      </div>
    </div>
    <div class="tw" id="tw" style="display:none">
      <table>
        <thead><tr><th>#</th><th>Planta</th><th>Subplanta</th><th>M√°quina</th><th>Equipo</th><th>Ubicaci√≥n</th><th>Di√°m.</th><th>SAE</th><th>Presi√≥n</th><th>Long.</th><th>Recubrim.</th><th>Term. A</th><th>Term. B</th><th>Comentarios</th><th>Descripci√≥n</th><th></th></tr></thead>
        <tbody id="tb"></tbody>
      </table>
    </div>
  </div>
</div>
<div class="toast" id="toast"></div>

<!-- BARRA FIJA M√ìVIL (desktop fallback) -->
<div id="mobileBar" style="display:none;">
  <div class="mb-cnt"><strong id="mbCount">0</strong> registros</div>
  <button class="mb-xl" id="mbExcel" onclick="exportExcel()" disabled>‚¨á Descargar Excel</button>
</div>

<script>
let confResolve=null;
function showConfirm(msg,okLabel='Eliminar'){
  return new Promise(resolve=>{
    confResolve=(v)=>{document.getElementById('confOv').style.display='none';resolve(v);};
    document.getElementById('confMsg').textContent=msg;
    document.getElementById('confOkBtn').textContent=okLabel;
    document.getElementById('confOv').style.display='flex';
  });
}

const SUFFIX=`EL CONECTOR Y LA MANGUERA DEBEN SER PROPORCIONADOS POR EL MISMO PROVEEDOR. EL CRIMPADO ENTRE LA MANGUERA Y LAS CONEXIONES DEBER√Å SUJETARSE A LA NORMA SAE J516 O SU EQUIVALENTE EN NORMA EN. EL ENSAMBLE DEBER√Å TENER UN N√öMERO DE IDENTIFICACI√ìN √öNICO CORRELATIVO DEL PROVEEDOR SIN DEFORMARLO (N√öMERO DE ART√çCULO; EN CASO DE NO TENER N√öMERO DE ART√çCULO COLOCAR EL N√öMERO DE ORDEN DE TRABAJO) Y LA FECHA DE ENSAMBLE REALIZADOS CON L√ÅPIZ EL√âCTRICO. DEBER√Å VENIR ENSAMBLADA CON ACOPLES PERMANENTES Y NO SE DEBE PELAR LA MANGUERA PARA EL CRIMPADO. DEBER√Å ESTAR SECA Y LIMPIA EN SU INTERIOR AS√ç MISMO TENER EN AMBOS EXTREMOS TAPONES DE PL√ÅSTICO ROSCADOS PARA SU PROTECCI√ìN Y SE DEBER√Å SUMINISTRAR DE FORMA INDIVIDUAL EN UNA BOLSA PL√ÅSTICA RESISTENTE.`;
const STOR='suminregio_v5';
let records=[],files=[],results=[],rIdx=0,scanCount=0;

// Storage

// API KEY MANAGEMENT
const PROXY_URL = 'https://suminregio-proxy.onrender.com'; // Ej: https://mi-proxy.up.railway.app
let API_KEY = localStorage.getItem('sr_apikey') || '';
function checkKey(){
  if(!API_KEY){document.getElementById('akOv').style.display='flex';}
  else{document.getElementById('akOv').style.display='none';}
}
function saveKey(){
  const val=document.getElementById('akInput').value.trim();
  if(!val.startsWith('sk-ant')){document.getElementById('akErr').style.display='block';return;}
  API_KEY=val;
  localStorage.setItem('sr_apikey',val);
  document.getElementById('akOv').style.display='none';
  toast('‚úì API Key guardada','ok');
}

function load(){try{const s=localStorage.getItem(STOR);if(s){records=JSON.parse(s);render();}}catch(e){}}
function save(){try{localStorage.setItem(STOR,JSON.stringify(records));const el=document.getElementById('sp');el.classList.add('show');setTimeout(()=>el.classList.remove('show'),2000);}catch(e){}}
const g=id=>document.getElementById(id)?.value.trim()||'';
const gU=id=>g(id).toUpperCase();

function desc(r){const tA=r.adaptA?`${r.conA} CON ADAPTADOR ${r.adaptA}`:r.conA;const tB=r.adaptB?`${r.conB} CON ADAPTADOR ${r.adaptB}`:r.conB;const rc=r.recubrimiento?` CON RECUBRIMIENTO ${r.recubrimiento}`:'';return `MANGUERA HIDR√ÅULICA CON DI√ÅMETRO INTERIOR DE ${r.diametro} SAE ${r.sae} PARA UNA PRESI√ìN DE TRABAJO DE ${r.presion} PSI CON UNA LONGITUD DE ${r.longitud} MM${rc}. FORMA TERMINAL "A": ${tA}. FORMA TERMINAL "B": ${tB}. ${SUFFIX}`;}

// Manguera panel HTML
function mpHTML(n){
  const ds=`<option value="">--</option><option>1/4"</option><option>3/8"</option><option>1/2"</option><option>5/8"</option><option>3/4"</option><option>1"</option><option>1 1/4"</option><option>1 1/2"</option><option>2"</option>`;
  const ss=`<option value="">--</option><option>100R1AT</option><option>100R2AT</option><option>100R12</option><option>100R13</option><option>100R15</option><option>100R17</option>`;
  return `<div class="rg c1" style="margin-bottom:3px"><div class="rf"><label>Donde se conecta</label><input type="text" id="r${n}_ubicacion"></div></div><div class="rg c3" style="margin-bottom:3px"><div class="rf"><label>Di√°metro</label><select id="r${n}_diametro">${ds}</select></div><div class="rf"><label>SAE</label><select id="r${n}_sae">${ss}</select></div><div class="rf"><label>Presi√≥n</label><input type="number" id="r${n}_presion"></div></div><div class="rg" style="margin-bottom:3px"><div class="rf"><label>Longitud (MM)</label><input type="number" id="r${n}_longitud"></div><div class="rf"><label>Recubrimiento</label><input type="text" id="r${n}_recubrimiento"></div></div><div class="rg" style="margin-bottom:3px"><div class="rf"><label>Conector A</label><input type="text" id="r${n}_conA"></div><div class="rf"><label>Adaptador A</label><input type="text" id="r${n}_adaptA"></div></div><div class="rg" style="margin-bottom:3px"><div class="rf"><label>Conector B</label><input type="text" id="r${n}_conB"></div><div class="rf"><label>Adaptador B</label><input type="text" id="r${n}_adaptB"></div></div><div class="rg c1"><div class="rf"><label>Comentarios</label><input type="text" id="r${n}_comentarios"></div></div>`;
}
[1,2,3].forEach(n=>document.getElementById(`mp${n}`).innerHTML=mpHTML(n));

// Scan
function openScan(){
  files=[];
  document.getElementById('bq').innerHTML='';
  document.getElementById('bq').style.display='none';
  document.getElementById('bstart').disabled=true;
  document.getElementById('progWrap').classList.remove('show');
  document.getElementById('progFill').style.width='0%';
  document.getElementById('progPct').textContent='0%';
  document.getElementById('scanOv').style.display='flex';
}
function closeScan(){document.getElementById('scanOv').style.display='none';files=[];}
const dz=document.getElementById('dz');
dz.addEventListener('dragover',e=>{e.preventDefault();dz.classList.add('over');});
dz.addEventListener('dragleave',()=>dz.classList.remove('over'));
dz.addEventListener('drop',e=>{e.preventDefault();dz.classList.remove('over');addFiles([...e.dataTransfer.files].filter(f=>f.type.startsWith('image/')));});
function onFiles(e){addFiles([...e.target.files]);e.target.value='';}
function triggerFileOnly(){
  const fi=document.getElementById('fbi');
  fi.removeAttribute('capture');
  fi.click();
  setTimeout(()=>fi.setAttribute('capture','environment'),1000);
}
function compressImage(file,maxPx,quality){return new Promise(resolve=>{const r=new FileReader();r.onload=ev=>{const img=new Image();img.onload=()=>{let w=img.width,h=img.height;if(w>maxPx||h>maxPx){if(w>h){h=Math.round(h*maxPx/w);w=maxPx;}else{w=Math.round(w*maxPx/h);h=maxPx;}}const c=document.createElement('canvas');c.width=w;c.height=h;c.getContext('2d').drawImage(img,0,0,w,h);const b64full=c.toDataURL('image/jpeg',quality);resolve({b64:b64full.split(',')[1],mime:'image/jpeg',url:b64full});};img.src=ev.target.result;};r.readAsDataURL(file);});}
function addFiles(flist){
  [...flist].forEach(async f=>{
    const comp=await compressImage(f,1600,0.82);
    files.push({...comp,name:f.name,status:'pending'});
    renderQ();
  });
}
function renderQ(){const q=document.getElementById('bq');q.style.display=files.length?'flex':'none';document.getElementById('bstart').disabled=!files.length;q.innerHTML=files.map((f,i)=>`<div class="bi ${f.status}"><img class="bith" src="${f.url}"><div class="bii"><div class="bin">${f.name}</div><div class="bis ${f.status}">${f.status==='pending'?'En espera ‚Äî extraer√° hasta 3 mangueras':f.status==='processing'?'Analizando...':f.status==='done'?'‚úì Listo':'‚ö† '+(f.err||'Error')}</div></div>${f.status==='pending'?`<button class="birm" onclick="files.splice(${i},1);renderQ()">‚úï</button>`:''}</div>`).join('');}

const PROMPT=`Eres un asistente que lee formatos f√≠sicos de levantamiento de mangueras hidr√°ulicas llenados a mano. El formato tiene 4 CUADRANTES: superior izquierdo = datos generales, superior derecho = Manguera 1, inferior izquierdo = Manguera 2, inferior derecho = Manguera 3. Responde √öNICAMENTE con JSON sin markdown: {"generales":{"empresa":"","planta":"","subplanta":"","maquina":"","equipo":"","subequipo":"","tecnico":"","fecha_levantamiento":""},"mangueras":[{"numero":1,"ubicacion":"","diametro":"","sae":"","presion":"","longitud":"","recubrimiento":"","conA":"","adaptA":"","conB":"","adaptB":"","comentarios":""},{"numero":2,"ubicacion":"","diametro":"","sae":"","presion":"","longitud":"","recubrimiento":"","conA":"","adaptA":"","conB":"","adaptB":"","comentarios":""},{"numero":3,"ubicacion":"","diametro":"","sae":"","presion":"","longitud":"","recubrimiento":"","conA":"","adaptA":"","conB":"","adaptB":"","comentarios":""}]}. REGLAS DE INTERPRETACI√ìN: diametro: formato 1/4" 3/8" 1/2" 5/8" 3/4" 1" etc. sae: el campo tiene casillas R2 y R12 ‚Äî si la casilla R2 est√° marcada (X o palomita) devuelve exactamente "100R2AT"; si R12 est√° marcada devuelve exactamente "100R12"; si ninguna est√° marcada deja "". presion: el campo tiene casillas 3K 4K 5K 6K ‚Äî la casilla marcada equivale a: 3K=3000, 4K=4000, 5K=5000, 6K=6000 ‚Äî devuelve solo el n√∫mero sin unidades. recubrimiento: el campo tiene casillas Ninguno, Antiflama, Acero ‚Äî pueden estar marcadas una o varias; si Ninguno est√° marcada (o ninguna) deja ""; si solo Antiflama est√° marcada devuelve "ANTIFLAMA"; si solo Acero est√° marcada devuelve "ESPIRAL MET√ÅLICO"; si ambas Antiflama y Acero est√°n marcadas devuelve "ANTIFLAMA + ESPIRAL MET√ÅLICO". longitud: solo el n√∫mero. Cuadrantes vac√≠os o sin marcar dejar "".`;

async function runBatch(){
  if(!files.length)return;
  document.getElementById('bstart').disabled=true;
  document.getElementById('progWrap').classList.add('show');
  results=[];
  for(let i=0;i<files.length;i++){
    files[i].status='processing';renderQ();
    const pct=Math.round((i/files.length)*100);
    document.getElementById('progFill').style.width=pct+'%';
    document.getElementById('progPct').textContent=pct+'%';
    document.getElementById('progText').textContent=`Analizando ${i+1} de ${files.length}...`;
    let success=false;
    for(let attempt=1;attempt<=3;attempt++){
      try{
        if(attempt>1){
          const wait=attempt*8000;
          document.getElementById('progText').textContent=`Reintentando ${attempt}/3 ‚Äî espera ${wait/1000}s...`;
          await new Promise(r=>setTimeout(r,wait));
        }
        const resp=await fetch(PROXY_URL+"/api/scan",{method:"POST",headers:{"Content-Type":"application/json","x-api-key":API_KEY,"anthropic-version":"2023-06-01"},body:JSON.stringify({model:"claude-sonnet-4-20250514",max_tokens:2000,messages:[{role:"user",content:[{type:"image",source:{type:"base64",media_type:files[i].mime,data:files[i].b64}},{type:"text",text:PROMPT}]}]})});
        const data=await resp.json();
        const isOverloaded=data.error?.type==='overloaded_error'||resp.status===529||resp.status===503;
        if(isOverloaded&&attempt<3)continue;
        if(!resp.ok||data.error)throw new Error(data.error?.message||`HTTP ${resp.status}`);
        const raw=data.content.map(b=>b.text||'').join('').replace(/```json|```/g,'').trim();
        results.push({data:JSON.parse(raw),url:files[i].url});
        files[i].status='done';
        success=true;
        break;
      }catch(e){
        if(attempt===3){
          files[i].status='error';files[i].err=e.message.substring(0,40);
          results.push(null);toast('Error: '+e.message.substring(0,60),'err');
        }
      }
    }
    renderQ();
  }
  document.getElementById('progFill').style.width='100%';
  document.getElementById('progPct').textContent='100%';
  await new Promise(r=>setTimeout(r,400));
  document.getElementById('progWrap').classList.remove('show');
  closeScan();rIdx=0;nextReview();
}

function swTab(n){document.querySelectorAll('.tab').forEach((t,i)=>t.classList.toggle('active',i===n-1));document.querySelectorAll('.mp').forEach((p,i)=>p.classList.toggle('active',i===n-1));}
function fSel(id,val){if(!val)return;const el=document.getElementById(id);if(!el)return;const v=val.toLowerCase();const m=[...el.options].find(o=>o.value&&(o.value.toLowerCase()===v||v.includes(o.value.toLowerCase())));if(m){el.value=m.value;el.classList.add('sc');}}

function nextReview(){
  while(rIdx<results.length&&!results[rIdx])rIdx++;
  if(rIdx>=results.length){document.getElementById('revOv').style.display='none';toast('‚úì Todos los formatos procesados','ok');return;}
  const tot=results.filter(Boolean).length,done=results.slice(0,rIdx).filter(Boolean).length;
  document.getElementById('rmc').textContent=`Hoja ${done+1} de ${tot}`;
  document.getElementById('rimg').src=results[rIdx].url;
  const{data}=results[rIdx],gen=data.generales||{};
  const gm={empresa:'r_empresa',planta:'r_planta',subplanta:'r_subplanta',maquina:'r_maquina',equipo:'r_equipo',subequipo:'r_subequipo',tecnico:'r_tecnico',fecha_levantamiento:'r_fecha_lev'};
  Object.entries(gm).forEach(([k,id])=>{const el=document.getElementById(id);if(el){el.value=gen[k]||'';el.classList.toggle('sc',!!(gen[k]));}});
  (data.mangueras||[]).forEach((m,idx)=>{const n=idx+1;['ubicacion','presion','longitud','recubrimiento','conA','adaptA','conB','adaptB','comentarios'].forEach(f=>{const el=document.getElementById(`r${n}_${f}`);if(el){el.value=m[f]||'';el.classList.toggle('sc',!!(m[f]));} });fSel(`r${n}_diametro`,m.diametro);fSel(`r${n}_sae`,m.sae);});
  swTab(1);document.getElementById('revOv').style.display='flex';
}

function saveRev(){
  const rv=id=>document.getElementById(id)?.value.trim()||'',rvU=id=>rv(id).toUpperCase();
  const gen={planta:rvU('r_planta'),subplanta:rvU('r_subplanta'),maquina:rvU('r_maquina'),equipo:rvU('r_equipo')};
  let saved=0;
  for(let n=1;n<=3;n++){
    const d=rv(`r${n}_diametro`),s=rv(`r${n}_sae`),p=rv(`r${n}_presion`),l=rv(`r${n}_longitud`),cA=rvU(`r${n}_conA`),cB=rvU(`r${n}_conB`);
    if(!d||!s||!p||!l||!cA||!cB)continue;
    const r={id:Date.now()+n,fecha:new Date().toLocaleDateString('es-MX'),...gen,ubicacion:rvU(`r${n}_ubicacion`),diametro:d,sae:s,presion:p,longitud:l,recubrimiento:rvU(`r${n}_recubrimiento`),conA:cA,adaptA:rvU(`r${n}_adaptA`),conB:cB,adaptB:rvU(`r${n}_adaptB`),comentarios:rv(`r${n}_comentarios`)};
    r.descripcion=desc(r);records.push(r);saved++;
  }
  if(!saved){toast('Completa al menos una manguera con los campos requeridos','warn');return;}
  save();render();toast(`‚úì ${saved} registro${saved>1?'s':''} guardados`,'ok');scanCount++;
  rIdx++;nextReview();
}
function skipRev(){rIdx++;nextReview();}

function addEntry(){
  const d=g('diametro'),s=g('sae'),p=g('presion'),l=g('longitud'),cA=gU('conA'),cB=gU('conB');
  if(!d||!s||!p||!l||!cA||!cB){toast('Completa: Di√°metro, SAE, Presi√≥n, Longitud, Conector A y B','warn');return;}
  const r={id:Date.now(),fecha:new Date().toLocaleDateString('es-MX'),planta:gU('planta'),subplanta:gU('subplanta'),maquina:gU('maquina'),equipo:gU('equipo'),ubicacion:gU('ubicacion'),diametro:d,sae:s,presion:p,longitud:l,recubrimiento:g('recubrimiento').toUpperCase(),conA:cA,adaptA:gU('adaptA'),conB:cB,adaptB:gU('adaptB'),comentarios:g('comentarios')};
  r.descripcion=desc(r);records.push(r);save();render();clearForm();toast('‚úì Registro guardado','ok');
}

function toggleForm(){
  const t=document.getElementById('formToggle');
  const c=document.getElementById('formCollapse');
  t.classList.toggle('open');
  c.classList.toggle('open');
}

function openManualMobile(){
  document.getElementById('manualMobOv').style.display='flex';
}

function addEntryMobile(){
  const gm=id=>document.getElementById(id)?.value.trim()||'';
  const gmU=id=>gm(id).toUpperCase();
  const d=gm('m_diametro'),s=gm('m_sae'),p=gm('m_presion'),l=gm('m_longitud'),cA=gmU('m_conA'),cB=gmU('m_conB');
  if(!d||!s||!p||!l||!cA||!cB){toast('Completa: Di√°metro, SAE, Presi√≥n, Longitud, Conector A y B','warn');return;}
  const r={id:Date.now(),fecha:new Date().toLocaleDateString('es-MX'),
    planta:gmU('m_planta'),subplanta:gmU('m_subplanta'),maquina:gmU('m_maquina'),equipo:gmU('m_equipo'),
    ubicacion:gmU('m_ubicacion'),diametro:d,sae:s,presion:p,longitud:l,
    recubrimiento:gm('m_recubrimiento').toUpperCase(),conA:cA,adaptA:gmU('m_adaptA'),conB:cB,adaptB:gmU('m_adaptB'),
    comentarios:gm('m_comentarios')};
  r.descripcion=desc(r);records.push(r);save();render();
  document.getElementById('manualMobOv').style.display='none';
  toast('‚úì Registro guardado','ok');
}

function updateHero(){
  const hc=document.getElementById('heroCount');
  const hs=document.getElementById('heroSheets');
  const mb=document.getElementById('mbExcel');
  if(hc) hc.textContent=records.length;
  if(hs) hs.textContent=scanCount;
  if(mb) mb.disabled=!records.length;
}

function render(){
  const tb=document.getElementById('tb'),em=document.getElementById('em'),tw=document.getElementById('tw'),btn=document.getElementById('bex');
  const rcEl=document.getElementById('rc');if(rcEl)rcEl.textContent=records.length;
  const rc2El=document.getElementById('rc2');if(rc2El)rc2El.textContent=records.length;
  const bex2El=document.getElementById('bex2');if(bex2El)bex2El.disabled=!records.length;
  // Sync mobile bar counter
  const mbCount=document.getElementById('mbCount');
  const mbExcel=document.getElementById('mbExcel');
  if(mbCount) mbCount.textContent=records.length;
  if(mbExcel) mbExcel.disabled=!records.length;
  updateHero();
  if(!records.length){em.style.display='flex';tw.style.display='none';btn.disabled=true;return;}
  em.style.display='none';tw.style.display='block';btn.disabled=false;
  tb.innerHTML=records.map((r,i)=>`<tr id="row-${r.id}" ${i>=records.length-3?'class="nr"':''}><td class="num">${i+1}</td><td>${r.planta||'‚Äî'}</td><td>${r.subplanta||'‚Äî'}</td><td>${r.maquina||'‚Äî'}</td><td>${r.equipo||'‚Äî'}</td><td>${r.ubicacion||'‚Äî'}</td><td><span class="chip">${r.diametro}</span></td><td><span class="chip">${r.sae}</span></td><td>${r.presion} PSI</td><td>${r.longitud} mm</td><td>${r.recubrimiento||'‚Äî'}</td><td class="wc">${r.conA}${r.adaptA?`<br><span style="color:var(--mu2);font-size:9px">+${r.adaptA}</span>`:''}</td><td class="wc">${r.conB}${r.adaptB?`<br><span style="color:var(--mu2);font-size:9px">+${r.adaptB}</span>`:''}</td><td class="wc" style="color:var(--mu)">${r.comentarios||'‚Äî'}</td><td class="dc">${r.descripcion.substring(0,90)}‚Ä¶</td><td><div class="ra"><button class="bcp" onclick="cpDesc(${r.id},this)" title="Copiar descripci√≥n">Copiar</button><button class="bdl" onclick="delRow(${r.id})" title="Eliminar">‚úï</button></div></td></tr>`).join('');
}
function cpDesc(id,btn){const r=records.find(x=>x.id===id);if(!r)return;navigator.clipboard.writeText(r.descripcion).then(()=>{btn.textContent='‚úì';btn.classList.add('ok');setTimeout(()=>{btn.textContent='üìã';btn.classList.remove('ok');},2000);});}
async function delRow(id){if(!await showConfirm('¬øEliminar este registro?'))return;records=records.filter(r=>r.id!==id);save();render();}
async function clearAll(){if(!await showConfirm('¬øEliminar todos los registros? Esta acci√≥n no se puede deshacer.','Eliminar todo'))return;records=[];localStorage.removeItem(STOR);render();}
function clearForm(){['planta','subplanta','maquina','equipo','ubicacion','presion','longitud','conA','adaptA','conB','adaptB','comentarios'].forEach(id=>document.getElementById(id).value='');['diametro','sae','recubrimiento'].forEach(id=>document.getElementById(id).value='');}
function exportExcel(){
  if(!records.length)return;
  const h=['FECHA','PLANTA','SUBPLANTA','M√ÅQUINA','EQUIPO','DONDE SE CONECTA','DI√ÅMETRO','SAE','PRESI√ìN PSI','LONGITUD MM','RECUBRIMIENTO','CONECTOR A','ADAPTADOR A','CONECTOR B','ADAPTADOR B','COMENTARIOS','DESCRIPCI√ìN DE MANGUERA'];
  const rows=records.map(r=>[r.fecha,r.planta,r.subplanta,r.maquina,r.equipo,r.ubicacion,r.diametro,r.sae,Number(r.presion),Number(r.longitud),r.recubrimiento,r.conA,r.adaptA,r.conB,r.adaptB,r.comentarios,r.descripcion]);
  const ws=XLSX.utils.aoa_to_sheet([h,...rows]);ws['!cols']=[10,14,14,16,18,16,9,10,11,11,14,26,20,26,20,28,100].map(w=>({wch:w}));
  const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'Levantamiento');
  XLSX.writeFile(wb,`Suminregio_Levantamiento_${new Date().toISOString().slice(0,10)}.xlsx`);
  toast('‚úì Excel descargado','ok');
}
function toast(msg,type='ok'){const t=document.getElementById('toast');t.textContent=msg;t.className=`toast ${type} show`;setTimeout(()=>t.classList.remove('show'),3500);}
document.addEventListener('keydown',e=>{if(e.ctrlKey&&e.key==='Enter')addEntry();});

checkKey();
load();
</script>

<!-- CONFIRM DIALOG -->
<div class="conf-ov" id="confOv" style="display:none">
  <div class="conf-box">
    <div class="conf-title" id="confTitle">¬øConfirmar?</div>
    <div class="conf-msg" id="confMsg"></div>
    <div class="conf-btns">
      <button class="conf-cancel" onclick="confResolve(false)">Cancelar</button>
      <button class="conf-ok" id="confOkBtn" onclick="confResolve(true)">Eliminar</button>
    </div>
  </div>
</div>

</body>
</html>
